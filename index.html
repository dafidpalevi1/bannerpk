<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Banner PK - Final (Fixed Download Issues)</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<!-- html2canvas untuk export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  :root {
    --width: 420px;
    --height: 880px;
    --orange: #ff9a2a;
    --orange-deep: #ff7b1a;
    --orange-bright: #ffaa33;
    --silver-light: #f5f5f5;
    --silver-dark: #a6a6a6;
    --bg-dark: #07141b;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    min-height: 100vh;
    background: linear-gradient(180deg, #03060a 0%, #061022 100%);
    font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    padding: 18px;
  }

  .banner-wrap {
    display: flex;
    gap: 18px;
    align-items: flex-start;
    width: 100%;
    max-width: 1200px;
    justify-content: center;
  }
  .banner {
    width: var(--width);
    height: var(--height);
    border-radius: 14px;
    overflow: hidden;
    position: relative;
    background: url('img/latar.jpeg') no-repeat center center; /* Placeholder until you upload latar.jpeg */
    background-size: cover;
    box-shadow: 0 18px 60px rgba(0, 0, 0, 0.6);
  }

  .logos {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: center;
    padding-top: 50px;
    z-index: 6;
    position: relative;
  }
  .logos img { height: 34px; display: block; }

  .title {
    text-align: center;
    margin-top: 18px;
    font-family: "Montserrat", sans-serif;
    font-size: 46px;
    font-weight: 800;
    z-index: 6;
  }
  .subtitle {
    text-align: center;
    margin-top: 6px;
    color: #f6c46a;
    font-weight: 700;
    font-size: 14px;
    z-index: 6;
  }

  /* date box with alarm clock icon centered */
  .date-box {
    width: 86%;
    margin: 18px auto;
    max-width: 260px;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 10px;
    background: linear-gradient(90deg, #ff8848, #ff9f42);
    padding: 16px;
    border-radius: 10px;
    z-index: 6;
  }
  .date-icon {
    width: 40px;
    height: 40px;
    background: var(--orange-bright);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    border: 2px solid #ff9a2a;
  }
  .date-icon svg { width: 20px; height: 20px; }
  .date-icon svg path, .date-icon svg circle {
    stroke: #ffffff;
    stroke-width: 2;
    fill: none;
  }
  .date-text {
    color: #fff;
    font-weight: 700;
    font-size: 16px;
    line-height: 1.3;
    text-transform: uppercase;
    text-align: left;
    width: auto;
  }

  .vs-band {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin: 18px 32px;
    z-index: 6;
  }
  .vs-left, .vs-right {
    flex: 1;
    height: 40px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 15px;
    color: #fff;
    padding: 0 8px;
  }
  .vs-left { background: linear-gradient(90deg, #bf6b2b, #ffb26b); text-align: right; }
  .vs-right { background: linear-gradient(90deg, #6637ff, #a45cff); text-align: left; }
  .vs-center {
    width: 58px;
    height: 58px;
    background: linear-gradient(180deg, #ff7b1a, #ffbf5f);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 22px;
    color: #111;
    border-radius: 12px;
  }

  .players {
    display: flex;
    gap: 30px;
    justify-content: center;
    margin-top: 18px;
    z-index: 6;
  }
  .player { width: 150px; text-align: center; }
  .avatar-wrap {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fff;
    overflow: hidden;
  }
  .avatar { width: 122px; height: 122px; border-radius: 50%; object-fit: cover; display: block; }
  .name-tag {
    margin-top: 12px;
    font-weight: 700;
    padding: 10px 18px;
    border-radius: 10px;
    font-size: 15px;
    display: inline-block;
    min-width: 120px;
  }
  .player.left .name-tag { background: linear-gradient(90deg, #ff8b25, #ffad56); }
  .player.right .name-tag { background: linear-gradient(90deg, #6637ff, #a45cff); }

  .rounds {
    margin: 34px auto 22px;
    width: 86%;
    text-align: center;
    border-radius: 30px;
    padding: 12px 18px;
    background: linear-gradient(90deg, var(--silver-light), var(--silver-dark));
    color: #111;
    font-weight: 800;
    font-size: 18px;
    z-index: 6;
  }
  .rounds .glow {
    display: inline-block;
    padding: 4px 18px;
    border-radius: 8px;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
    box-shadow: 0 8px 22px rgba(255, 255, 255, 0.18);
  }

  .bottom {
    position: absolute;
    bottom: 110px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 18px;
    z-index: 6;
  }
  .footer-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 13px;
    color: #fff;
    background: rgba(255, 255, 255, 0.03);
    padding: 8px 10px;
    border-radius: 10px;
  }
  .footer-item img { width: 18px; height: 18px; display: block; }

  /* Editor */
  .editor {
    width: 100%;
    max-width: 720px;
    background: rgba(255, 255, 255, 0.03);
    padding: 14px;
    border-radius: 12px;
    display: grid;
    gap: 10px;
    box-sizing: border-box;
  }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .col { display: flex; flex-direction: column; gap: 6px; }
  label { font-size: 13px; color: #eee; font-weight: 700; }
  input[type="text"], input[type="number"], input[type="file"], select {
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: #fff;
    padding: 8px 10px;
    border-radius: 8px;
  }
  select { color: #fff; background: rgba(0, 0, 0, 0.45); }
  option { background: #111; color: #fff; }
  .small { font-size: 12px; color: rgba(255, 255, 255, 0.7); }

  .row-buttons { display: flex; gap: 10px; }
  .btn {
    background: linear-gradient(90deg, var(--orange), var(--orange-deep));
    border: none;
    color: #111;
    padding: 10px 14px;
    border-radius: 10px;
    font-weight: 800;
    cursor: pointer;
  }

  /* Responsive Design */
  @media (max-width: 980px) {
    .banner-wrap { flex-direction: column; align-items: center; }
    .editor { max-width: 92vw; }
    .grid-3 { grid-template-columns: repeat(2, 1fr); }
    .banner { width: 90vw; max-width: var(--width); height: auto; aspect-ratio: 420/880; }
  }
  @media (max-width: 560px) {
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    .banner { width: 95vw; max-width: var(--width); transform: none; }
    .banner-wrap { gap: 8px; padding: 8px; }
    .editor { padding: 8px; max-width: 100vw; }
    .row-buttons { flex-direction: column; }
    .btn { width: 100%; }
    .title { font-size: 36px; }
    .subtitle { font-size: 12px; }
    .date-box { padding: 12px; }
    .date-text { font-size: 14px; }
    .vs-band { margin: 14px 24px; }
    .vs-left, .vs-right { font-size: 13px; }
    .vs-center { width: 48px; height: 48px; font-size: 18px; }
    .players { gap: 20px; }
    .player { width: 120px; }
    .avatar-wrap { width: 120px; height: 120px; }
    .avatar { width: 100px; height: 100px; }
    .name-tag { font-size: 13px; padding: 8px 14px; min-width: 100px; }
    .rounds { margin: 24px auto 16px; font-size: 16px; }
    .bottom { bottom: 80px; gap: 12px; }
    .footer-item { font-size: 11px; padding: 6px 8px; }
    .footer-item img { width: 16px; height: 16px; }
  }
</style>
</head>
<body>

<div class="banner-wrap">
  <!-- BANNER -->
  <div class="banner" id="banner">

    <div class="logos">
      <img id="logoA" src="img/logovip.png" alt="VIP logo">
      <img id="logoB" src="img/logotiktok.png" alt="TikTok logo" style="height:30px;">
    </div>

    <div class="title" id="bannerTitle">MATCH KUY</div>
    <div class="subtitle" id="bannerSubtitle">PK MATCH LOKAL</div>

    <div class="date-box">
      <div class="date-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <circle cx="12" cy="12" r="8" stroke="#ffffff" stroke-width="2"/>
          <path d="M12 7v5l3 2" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M7 3l-1 1m10-1l1 1" stroke="#ffffff" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="date-text" id="bannerDate">Rabu 17-09-2025<br>Pukul 17:15 WIB</div> <!-- Updated to current date and time -->
    </div>

    <div class="vs-band">
      <div class="vs-left" id="bannerAgency">VIP</div>
      <div class="vs-center">VS</div>
      <div class="vs-right" id="bannerOpponent">VIP</div>
    </div>

    <div class="players">
      <div class="player left">
        <div class="avatar-wrap">
          <img id="bannerAvatarLeft" class="avatar" src="https://images.unsplash.com/photo-1494790108377-be9c29b29330" alt="avatar left">
        </div>
        <div class="name-tag" id="bannerPlayerLeft">username</div>
      </div>

      <div class="player right">
        <div class="avatar-wrap">
          <img id="bannerAvatarRight" class="avatar" src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d" alt="avatar right">
        </div>
        <div class="name-tag" id="bannerPlayerRight">username</div>
      </div>
    </div>

    <div class="rounds" id="bannerRounds"><span class="glow">3 ROUND  | ON BOOSTER</span></div>

    <div class="bottom">
      <div class="footer-item"><img id="tiktokIcon" alt="tiktok icon"><span id="bannerTiktok">@vip_agency</span></div>
      <div class="footer-item"><img id="igIcon" alt="ig icon"><span id="bannerInstagram">@vin_industry_project</span></div>
    </div>
  </div>

  <!-- EDITOR -->
  <div class="editor" id="editor">
    <div class="grid-3">
      <div class="col"><label for="inputDay">Hari</label><input id="inputDay" type="text" value="Rabu"></div>
      <div class="col"><label for="inputDate">Tanggal</label><input id="inputDate" type="text" value="17"></div>
      <div class="col"><label for="inputMonth">Bulan</label><input id="inputMonth" type="text" value="09"></div>
    </div>

    <div class="grid-2">
      <div class="col"><label for="inputYear">Tahun</label><input id="inputYear" type="text" value="2025"></div>
      <div class="col"><label for="inputTime">Jam</label><input id="inputTime" type="text" value="17:15 WIB"></div>
    </div>

    <div class="grid-2">
      <div class="col"><label for="inputAgency">Nama Agency (kiri)</label><input id="inputAgency" type="text" value="VIP"></div>
      <div class="col"><label for="inputOpponent">Nama Lawan (kanan)</label><input id="inputOpponent" type="text" value="VIP"></div>
    </div>

    <div class="grid-2">
      <div class="col"><label for="inputPlayerLeft">Nama Player Kiri</label><input id="inputPlayerLeft" type="text" value="username"></div>
      <div class="col"><label for="inputPlayerRight">Nama Player Kanan</label><input id="inputPlayerRight" type="text" value="username"></div>
    </div>

    <div class="grid-2">
      <div class="col"><label for="uploadLeft">Foto Player Kiri (upload)</label><input id="uploadLeft" type="file" accept="image/*"><div class="small">Jika upload, gambar akan dipakai dan disertakan saat download.</div></div>
      <div class="col"><label for="uploadRight">Foto Player Kanan (upload)</label><input id="uploadRight" type="file" accept="image/*"><div class="small">Jika upload, gambar akan dipakai dan disertakan saat download.</div></div>
    </div>

    <div class="col"><label for="inputMatchType">Jenis PK Match</label><select id="inputMatchType"><option>PK MATCH LOKAL</option><option>PK MATCH INTERNASIONAL</option></select></div>

    <div class="grid-2">
      <div class="col"><label for="inputRound">Round (angka)</label><input id="inputRound" type="number" min="1" value="3"></div>
      <div class="col"><label for="inputBooster">Booster</label><select id="inputBooster"><option>ON</option><option>OFF</option></select></div>
    </div>

    <div class="grid-2">
      <div class="col"><label for="inputTiktok">TikTok (teks)</label><input id="inputTiktok" type="text" value="@vip_agency"></div>
      <div class="col"><label for="inputInstagram">Instagram (teks)</label><input id="inputInstagram" type="text" value="@vin_industry_project"></div>
    </div>

    <div class="row-buttons">
      <button class="btn" id="downloadBtn">Download Banner (HD)</button>
      <button class="btn" id="resetBtn">Reset Default</button>
    </div>
  </div>
</div>

<script>
/* ========== fallback inline SVGs & helper ========== */
function svgDataUrl(svg) {
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

const LOGO_VIP_SVG = svgDataUrl('<svg xmlns="http://www.w3.org/2000/svg" width="160" height="40"><rect rx="8" width="160" height="40" fill="#07141f"/><text x="16" y="26" font-family="Montserrat" font-size="18" fill="#fff">VIP</text></svg>');
const LOGO_TT_SVG = svgDataUrl('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="40"><rect rx="8" width="120" height="40" fill="#07141f"/><text x="12" y="26" font-family="Montserrat" font-size="14" fill="#fff">TIKTOK</text></svg>');
const TIKTOK_ICON_SVG = svgDataUrl('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 8v8a4 4 0 1 0 4-4V6h3" stroke="#ffffff" stroke-width="1.6" fill="none"/></svg>');
const IG_ICON_SVG = svgDataUrl('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="5" stroke="#ffffff" stroke-width="1.6" fill="none"/><path d="M16 11.37A4 4 0 1 1 12.63 8" stroke="#ffffff" stroke-width="1.6" fill="none"/></svg>');

function defaultAvatarSVG(initials, bg, textColor) {
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='400' height='400'><rect width='100%' height='100%' fill='${bg}' /><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Poppins, Montserrat, Arial' font-size='140' font-weight='800' fill='${textColor}'>${initials}</text></svg>`;
  return svgDataUrl(svg);
}
function initials(name) {
  if (!name) return 'U';
  return name.split(/\s+/).map(s => s[0]).slice(0, 2).join('').toUpperCase();
}

/* ========== DOM nodes ========== */
const logoA = document.getElementById('logoA');
const logoB = document.getElementById('logoB');
const tiktokIcon = document.getElementById('tiktokIcon');
const igIcon = document.getElementById('igIcon');

const bannerAvatarLeft = document.getElementById('bannerAvatarLeft');
const bannerAvatarRight = document.getElementById('bannerAvatarRight');

const inputPlayerLeft = document.getElementById('inputPlayerLeft');
const inputPlayerRight = document.getElementById('inputPlayerRight');
const uploadLeft = document.getElementById('uploadLeft');
const uploadRight = document.getElementById('uploadRight');

const inputDay = document.getElementById('inputDay');
const inputDate = document.getElementById('inputDate');
const inputMonth = document.getElementById('inputMonth');
const inputYear = document.getElementById('inputYear');
const inputTime = document.getElementById('inputTime');
const inputAgency = document.getElementById('inputAgency');
const inputOpponent = document.getElementById('inputOpponent');
const inputMatchType = document.getElementById('inputMatchType');
const inputRound = document.getElementById('inputRound');
const inputBooster = document.getElementById('inputBooster');
const inputTiktok = document.getElementById('inputTiktok');
const inputInstagram = document.getElementById('inputInstagram');

const bannerDate = document.getElementById('bannerDate');
const bannerAgency = document.getElementById('bannerAgency');
const bannerOpponent = document.getElementById('bannerOpponent');
const bannerPlayerLeft = document.getElementById('bannerPlayerLeft');
const bannerPlayerRight = document.getElementById('bannerPlayerRight');
const bannerRounds = document.getElementById('bannerRounds');
const bannerTiktok = document.getElementById('bannerTiktok');
const bannerInstagram = document.getElementById('bannerInstagram');

const downloadBtn = document.getElementById('downloadBtn');
const resetBtn = document.getElementById('resetBtn');

const banner = document.getElementById('banner');

/* ========== initial images (try to use your files first) ========== */
logoA.addEventListener('error', () => { logoA.src = LOGO_VIP_SVG; });
logoB.addEventListener('error', () => { logoB.src = LOGO_TT_SVG; });
logoA.src = logoA.src || LOGO_VIP_SVG;
logoB.src = logoB.src || LOGO_TT_SVG;
tiktokIcon.src = TIKTOK_ICON_SVG;
igIcon.src = IG_ICON_SVG;

/* avatars: use online images with fallback to SVG */
const PLACEHOLDER_LEFT = 'https://images.unsplash.com/photo-1494790108377-be9c29b29330'; // Female avatar
const PLACEHOLDER_RIGHT = 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d'; // Male avatar
const DEFAULT_LEFT_INLINE = defaultAvatarSVG(initials(inputPlayerLeft.value), '#e7e3d8', '#222');
const DEFAULT_RIGHT_INLINE = defaultAvatarSVG(initials(inputPlayerRight.value), '#dfe7ff', '#222');

function setWithFallback(imgEl, preferred, fallback) {
  imgEl.src = preferred;
  imgEl.onerror = () => { imgEl.onerror = null; imgEl.src = fallback; };
}
setWithFallback(bannerAvatarLeft, PLACEHOLDER_LEFT, DEFAULT_LEFT_INLINE);
setWithFallback(bannerAvatarRight, PLACEHOLDER_RIGHT, DEFAULT_RIGHT_INLINE);

/* ========== live updates ========== */
function updateDateText() {
  const d = (inputDay.value || '').trim();
  const dd = (inputDate.value || '').toString().padStart(2, '0');
  const mm = (inputMonth.value || '').toString().padStart(2, '0');
  const yy = (inputYear.value || '').trim();
  const tm = (inputTime.value || '').trim();
  const dayPart = d ? d + ' ' : '';
  const datePart = (dd && mm && yy) ? `${dd}-${mm}-${yy}` : '';
  if (datePart || tm) {
    bannerDate.innerHTML = `${dayPart}${datePart}<br>Pukul ${tm || ''}`.trim();
  } else bannerDate.innerHTML = '';
}
function updateAll() {
  document.getElementById('bannerSubtitle').textContent = inputMatchType.value || 'PK MATCH LOKAL';
  bannerAgency.textContent = inputAgency.value || 'VIP';
  bannerOpponent.textContent = inputOpponent.value || 'VIP';
  bannerPlayerLeft.textContent = inputPlayerLeft.value || 'username';
  bannerPlayerRight.textContent = inputPlayerRight.value || 'username';
  const r = (inputRound.value || '').toString().trim() || '3';
  const booster = inputBooster.value || 'ON';
  bannerRounds.innerHTML = `<span class="glow">${r} ROUND  | ${booster} BOOSTER</span>`;
  bannerTiktok.textContent = inputTiktok.value || '@vip_agency';
  bannerInstagram.textContent = inputInstagram.value || '@vin_industry_project';
  updateDateText();
  // Update avatars if no upload
  if (!uploadLeft.files.length) {
    setWithFallback(bannerAvatarLeft, PLACEHOLDER_LEFT, defaultAvatarSVG(initials(inputPlayerLeft.value || 'username'), '#e7e3d8', '#222'));
  }
  if (!uploadRight.files.length) {
    setWithFallback(bannerAvatarRight, PLACEHOLDER_RIGHT, defaultAvatarSVG(initials(inputPlayerRight.value || 'username'), '#dfe7ff', '#222'));
  }
}
/* attach */
[
  inputDay, inputDate, inputMonth, inputYear, inputTime,
  inputAgency, inputOpponent, inputPlayerLeft, inputPlayerRight,
  inputMatchType, inputRound, inputBooster, inputTiktok, inputInstagram
].forEach(el => {
  el.addEventListener('input', updateAll);
  el.addEventListener('change', updateAll);
});

/* upload preview (DataURL) */
uploadLeft.addEventListener('change', e => {
  const f = e.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = ev => { bannerAvatarLeft.src = ev.target.result; };
  r.readAsDataURL(f);
});
uploadRight.addEventListener('change', e => {
  const f = e.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = ev => { bannerAvatarRight.src = ev.target.result; };
  r.readAsDataURL(f);
});

/* update default avatars if name changed and no upload */
inputPlayerLeft.addEventListener('blur', () => {
  if (!uploadLeft.files.length) {
    setWithFallback(bannerAvatarLeft, PLACEHOLDER_LEFT, defaultAvatarSVG(initials(inputPlayerLeft.value || 'username'), '#e7e3d8', '#222'));
  }
});
inputPlayerRight.addEventListener('blur', () => {
  if (!uploadRight.files.length) {
    setWithFallback(bannerAvatarRight, PLACEHOLDER_RIGHT, defaultAvatarSVG(initials(inputPlayerRight.value || 'username'), '#dfe7ff', '#222'));
  }
});

/* reset button */
resetBtn.addEventListener('click', () => {
  inputDay.value = 'Rabu';
  inputDate.value = '17';
  inputMonth.value = '09';
  inputYear.value = '2025';
  inputTime.value = '17:15 WIB';
  inputAgency.value = 'VIP';
  inputOpponent.value = 'VIP';
  inputPlayerLeft.value = 'username';
  inputPlayerRight.value = 'username';
  inputMatchType.value = 'PK MATCH LOKAL';
  inputRound.value = '3';
  inputBooster.value = 'ON';
  inputTiktok.value = '@vip_agency';
  inputInstagram.value = '@vin_industry_project';
  uploadLeft.value = '';
  uploadRight.value = '';
  setWithFallback(bannerAvatarLeft, PLACEHOLDER_LEFT, DEFAULT_LEFT_INLINE);
  setWithFallback(bannerAvatarRight, PLACEHOLDER_RIGHT, DEFAULT_RIGHT_INLINE);
  logoA.src = 'img/logovip.png';
  logoB.src = 'img/logotiktok.png';
  updateAll();
});

/* initial update */
updateAll();

/* ========== prepare images for html2canvas ========== */
async function inlineImagesWithin(element) {
  const imgs = Array.from(element.querySelectorAll('img'));
  const promises = imgs.map(async img => {
    // Skip if already data URL or if it's an uploaded file
    if (!img.src || img.src.startsWith('data:') || img.src.includes('blob:')) return true;
    
    try {
      // For external images, try to fetch them
      const resp = await fetch(img.src, { mode: 'cors' });
      if (!resp.ok) throw new Error('fetch failed ' + resp.status);
      const blob = await resp.blob();
      return new Promise((resolve) => {
        const fr = new FileReader();
        fr.onload = () => { 
          img.dataset._origSrc = img.src; 
          img.src = fr.result; 
          resolve(true); 
        };
        fr.onerror = () => { 
          console.warn('Failed to read image as DataURL', img.src); 
          resolve(false); 
        };
        fr.readAsDataURL(blob);
      });
    } catch (err) {
      console.warn('Could not inline', img.src, err);
      // Use fallback SVGs for specific images
      if (img.id === 'bannerAvatarLeft') {
        img.src = defaultAvatarSVG(initials(inputPlayerLeft.value || 'username'), '#e7e3d8', '#222');
        return true;
      }
      if (img.id === 'bannerAvatarRight') {
        img.src = defaultAvatarSVG(initials(inputPlayerRight.value || 'username'), '#dfe7ff', '#222');
        return true;
      }
      if (img.id === 'logoA') {
        img.src = LOGO_VIP_SVG;
        return true;
      }
      if (img.id === 'logoB') {
        img.src = LOGO_TT_SVG;
        return true;
      }
      if (img.id === 'tiktokIcon') {
        img.src = TIKTOK_ICON_SVG;
        return true;
      }
      if (img.id === 'igIcon') {
        img.src = IG_ICON_SVG;
        return true;
      }
      return false;
    }
  });
  return Promise.all(promises);
}

/* download function using html2canvas with scale for HD */
async function downloadBanner({ filename = 'banner.png' } = {}) {
  // Show loading indicator
  const originalText = downloadBtn.textContent;
  downloadBtn.textContent = 'Loading...';
  downloadBtn.disabled = true;
  
  try {
    // Inline all images and handle failures
    const inlined = await inlineImagesWithin(banner);
    if (!inlined.every(Boolean)) {
      console.warn('Some images failed to inline, using fallbacks where possible');
    }

    // Ensure fonts are loaded
    await document.fonts.ready;

    // Create a clone of the banner for rendering
    const clonedBanner = banner.cloneNode(true);
    clonedBanner.id = 'cloned-banner-' + Date.now();
    document.body.appendChild(clonedBanner);
    
    // Position and style the clone to match original
    clonedBanner.style.position = 'absolute';
    clonedBanner.style.left = '0';
    clonedBanner.style.top = '0';
    clonedBanner.style.width = '420px';
    clonedBanner.style.height = '880px';
    clonedBanner.style.transform = 'none';
    clonedBanner.style.overflow = 'visible'; // Ensure corners are not clipped

    // Wait for images to load in the clone
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Render with html2canvas
    html2canvas(clonedBanner, {
      scale: 3,
      useCORS: true,
      allowTaint: false,
      backgroundColor: null,
      logging: false,
      onclone: function(clonedDoc, element) {
        const clonedElement = clonedDoc.getElementById(clonedBanner.id);
        if (clonedElement) {
          clonedElement.style.width = '420px';
          clonedElement.style.height = '880px';
          clonedElement.style.boxSizing = 'border-box';
          clonedElement.style.overflow = 'visible';
        }
      }
    }).then(canvas => {
      document.body.removeChild(clonedBanner);
      
      if (canvas.width === 0 || canvas.height === 0) {
        throw new Error('Canvas is empty');
      }
      
      canvas.toBlob(blob => {
        if (!blob) {
          throw new Error('Blob creation failed');
        }
        
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        
        // Restore original image sources
        banner.querySelectorAll('img').forEach(img => {
          if (img.dataset._origSrc) { 
            img.src = img.dataset._origSrc; 
            delete img.dataset._origSrc; 
          }
        });
        
        downloadBtn.textContent = originalText;
        downloadBtn.disabled = false;
      }, 'image/png', 1);
    }).catch(err => {
      document.body.removeChild(clonedBanner);
      throw err;
    });
  } catch (err) {
    console.error('Download error:', err);
    alert('Gagal membuat file. Pastikan untuk mengupload gambar lokal untuk hasil terbaik.');
    
    downloadBtn.textContent = originalText;
    downloadBtn.disabled = false;
    
    banner.querySelectorAll('img').forEach(img => {
      if (img.dataset._origSrc) { 
        img.src = img.dataset._origSrc; 
        delete img.dataset._origSrc; 
      }
    });
  }
}

/* attach download button */
downloadBtn.addEventListener('click', () => downloadBanner({ filename: 'banner-hd.png' }));
</script>
</body>
</html>